<!DOCTYPE html>
<html lang="en">

<head>
	<meta charset="UTF-8">
	<meta name="viewport" content="width=device-width, initial-scale=1.0">
	<title>Socket Server Test</title>
	<style>
		* {
			margin: 0;
			padding: 0;
			box-sizing: border-box;
		}

		body {
			font-family: 'Courier New', monospace;
			background: #1e1e1e;
			color: #e0e0e0;
			padding: 20px;
		}

		.container {
			max-width: 1200px;
			margin: 0 auto;
			display: grid;
			grid-template-columns: 1fr 1fr;
			gap: 20px;
		}

		.panel {
			background: #2d2d2d;
			border: 2px solid #3d3d3d;
			border-radius: 8px;
			padding: 20px;
		}

		.panel h2 {
			color: #4db8ff;
			margin-bottom: 15px;
			border-bottom: 2px solid #4db8ff;
			padding-bottom: 10px;
		}

		.status {
			display: flex;
			align-items: center;
			gap: 10px;
			margin-bottom: 20px;
			padding: 10px;
			background: #1e1e1e;
			border-radius: 4px;
		}

		.status-dot {
			width: 12px;
			height: 12px;
			border-radius: 50%;
			background: #ff4444;
		}

		.status-dot.connected {
			background: #44ff44;
		}

		.input-group {
			display: flex;
			gap: 10px;
			margin-bottom: 15px;
		}

		input {
			flex: 1;
			padding: 10px;
			background: #1e1e1e;
			border: 1px solid #3d3d3d;
			color: #e0e0e0;
			border-radius: 4px;
			font-family: inherit;
		}

		input:focus {
			outline: none;
			border-color: #4db8ff;
		}

		button {
			padding: 10px 20px;
			background: #4db8ff;
			border: none;
			color: #1e1e1e;
			border-radius: 4px;
			cursor: pointer;
			font-weight: bold;
			transition: background 0.3s;
		}

		button:hover {
			background: #2196F3;
		}

		button:active {
			background: #1976D2;
		}

		.log {
			background: #1e1e1e;
			border: 1px solid #3d3d3d;
			border-radius: 4px;
			padding: 10px;
			height: 300px;
			overflow-y: auto;
			font-size: 12px;
		}

		.log-entry {
			margin-bottom: 8px;
			padding: 5px;
			border-left: 3px solid #3d3d3d;
			padding-left: 10px;
		}

		.log-entry.sent {
			border-left-color: #4db8ff;
			color: #4db8ff;
		}

		.log-entry.received {
			border-left-color: #44ff44;
			color: #44ff44;
		}

		.log-entry.error {
			border-left-color: #ff4444;
			color: #ff4444;
		}

		.log-entry.info {
			border-left-color: #ffaa00;
			color: #ffaa00;
		}

		.button-group {
			display: grid;
			grid-template-columns: 1fr 1fr;
			gap: 10px;
			margin-bottom: 15px;
		}

		button.full-width {
			grid-column: 1 / -1;
		}

		.game-board {
			display: grid;
			grid-template-columns: repeat(10, 1fr);
			gap: 2px;
			background: #1a1a1a;
			padding: 10px;
			border: 3px solid #4db8ff;
			border-radius: 4px;
			margin-top: 15px;
			width: 100%;
		}

		.cell {
			aspect-ratio: 1;
			background: #0a0a0a;
			border: 1px solid #2a2a2a;
			border-radius: 2px;
		}

		.cell.filled {
			border-color: #4db8ff;
		}

		.cell.block-1 {
			background: #ff6b6b;
		}

		.cell.block-2 {
			background: #4ecdc4;
		}

		.cell.block-3 {
			background: #ffe66d;
		}

		.cell.block-4 {
			background: #95e1d3;
		}

		.cell.block-5 {
			background: #a8e6cf;
		}

		.cell.block-6 {
			background: #ffd3b6;
		}

		.cell.block-7 {
			background: #ffaaa5;
		}

		.game-container {
			display: grid;
			grid-template-columns: 1fr 2fr 1fr;
			gap: 20px;
			margin-top: 20px;
		}

		.game-panel {
			background: #2d2d2d;
			border: 2px solid #3d3d3d;
			border-radius: 8px;
			padding: 20px;
		}

		.game-display {
			background: #2d2d2d;
			border: 2px solid #3d3d3d;
			border-radius: 8px;
			padding: 20px;
			display: flex;
			justify-content: center;
			align-items: flex-start;
		}

		.game-info {
			display: grid;
			gap: 15px;
		}

		.info-item {
			background: #1e1e1e;
			padding: 10px;
			border-left: 3px solid #4db8ff;
			border-radius: 4px;
		}

		.info-label {
			color: #4db8ff;
			font-weight: bold;
			font-size: 12px;
			text-transform: uppercase;
		}

		.info-value {
			color: #44ff44;
			font-size: 18px;
			font-weight: bold;
		}

		@media (max-width: 768px) {
			.container {
				grid-template-columns: 1fr;
			}

			.game-container {
				grid-template-columns: 1fr;
			}
		}
	</style>
</head>

<body>
	<h1>üéÆ Tetris Game - Server Test Console</h1>

	<div class="container">
		<div class="panel">
			<h2>Connection Control</h2>

			<div class="status">
				<div class="status-dot" id="statusDot"></div>
				<span id="statusText">Disconnected</span>
			</div>

			<div class="input-group">
				<input type="text" id="playerName" placeholder="Enter player name" value="TestPlayer">
				<button onclick="connect()">Connect</button>
			</div>

			<div class="button-group">
				<button onclick="disconnect()">Disconnect</button>
				<button onclick="clearLog()">Clear Log</button>
			</div>

			<h3 style="margin-top: 20px; color: #4db8ff;">Join Room</h3>
			<div class="input-group">
				<input type="text" id="roomId" placeholder="Room ID" value="room1">
				<button onclick="joinRoom()">Join</button>
			</div>

			<h3 style="margin-top: 20px; color: #4db8ff;">Game Events</h3>
			<div class="button-group">
				<button onclick="requestGameInfo()">Request Game Info</button>
				<button onclick="startGame()">Start Game</button>
				<button onclick="stopGame()">Stop Game</button>
			</div>
		</div>

		<div class="panel">
			<h2>Event Log</h2>
			<div class="log" id="eventLog"></div>
		</div>
	</div>

	<!-- Game Display Section -->
	<div class="game-container">
		<div class="game-panel">
			<h3 style="color: #4db8ff; margin-bottom: 15px;">üìä Game Stats</h3>
			<div class="game-info">
				<div class="info-item">
					<div class="info-label">Score</div>
					<div class="info-value" id="playerScore">0</div>
				</div>
				<div class="info-item">
					<div class="info-label">Status</div>
					<div class="info-value" id="gameStatus">Waiting...</div>
				</div>
				<div class="info-item">
					<div class="info-label">Players</div>
					<div class="info-value" id="playerCount">0</div>
				</div>
			</div>
		</div>

		<div class="game-display">
			<div id="gameBoard" class="game-board"></div>
		</div>

		<div class="game-panel">
			<h3 style="color: #4db8ff; margin-bottom: 15px;">üë• Players Info</h3>
			<div id="playersList" style="max-height: 400px; overflow-y: auto;"></div>
		</div>
	</div>

	<script src="/socket.io/socket.io.js"></script>
	<script>
		let socket = null;

		function updateStatus(connected) {
			const dot = document.getElementById('statusDot');
			const text = document.getElementById('statusText');
			const socketId = socket?.id || 'N/A';

			if (connected) {
				dot.classList.add('connected');
				text.textContent = `Connected - ID: ${socketId}`;
			} else {
				dot.classList.remove('connected');
				text.textContent = 'Disconnected';
			}
		}

		function addLog(message, type = 'info') {
			const log = document.getElementById('eventLog');
			const entry = document.createElement('div');
			entry.className = `log-entry ${type}`;
			const time = new Date().toLocaleTimeString();
			entry.textContent = `[${time}] ${message}`;
			log.appendChild(entry);
			log.scrollTop = log.scrollHeight;
		}

		function clearLog() {
			document.getElementById('eventLog').innerHTML = '';
		}

		function connect() {
			if (socket && socket.connected) {
				addLog('Already connected', 'info');
				return;
			}

			socket = io();

			socket.on('connect', () => {
				addLog('‚úì Connected to server', 'received');
				updateStatus(true);
				const playerName = document.getElementById('playerName').value;
				if (playerName) {
					socket.emit('setPlayerName', playerName);
					addLog(`‚úì Sent player name: ${playerName}`, 'sent');
				}
			});

			socket.on('disconnect', () => {
				addLog('‚úó Disconnected from server', 'error');
				updateStatus(false);
			});

			socket.on('joinedRoom', (roomId) => {
				addLog(`‚úì Successfully joined room: ${roomId}`, 'received');
			});

			socket.on('roomFull', (roomId) => {
				addLog(`‚úó Room ${roomId} is full`, 'error');
			});

			// Listener for gameUpdate events from server (auto push)
			socket.on('gameUpdate', (data) => {
				console.log('Received gameUpdate:', data);
				if (data && data.length > 0) {
					displayGameBoard(data[0].gameSate);
					updatePlayersList(data);
					document.getElementById('playerScore').textContent = data[0].score;
					
					// Update game status based on gameActive state
					const gameStatus = document.getElementById('gameStatus');
					if (data[0].gameActive) {
						gameStatus.textContent = 'üéÆ RUNNING';
						gameStatus.style.color = '#44ff44';
					} else {
						gameStatus.textContent = 'üíÄ GAME OVER';
						gameStatus.style.color = '#ff4444';
					}
				}
			});

			socket.on('connect_error', (error) => {
				addLog(`Connection error: ${error.message}`, 'error');
			});

			socket.onAny((event, ...args) => {
				if (!['connect', 'disconnect', 'joinedRoom', 'roomFull', 'Gameinfo'].includes(event)) {
					addLog(`üì® Event: ${event} | Data: ${JSON.stringify(args)}`, 'received');
				}
			});
		}

		function disconnect() {
			if (socket) {
				socket.disconnect();
				addLog('Disconnecting...', 'info');
			}
		}

		function joinRoom() {
			const roomId = document.getElementById('roomId').value;

			if (!socket || !socket.connected) {
				addLog('Not connected to server', 'error');
				return;
			}

			addLog(`Attempting to join room: ${roomId}`, 'sent');
			socket.emit('joinRoom', roomId);
		}

		function requestGameInfo() {
			if (!socket || !socket.connected) {
				addLog('Not connected to server', 'error');
				return;
			}

			addLog('‚ö†Ô∏è Game info is now auto-synced via gameUpdate events', 'info');
		}

		function displayGameBoard(board) {
			const gameBoard = document.getElementById('gameBoard');
			gameBoard.innerHTML = '';

			if (!board || board.length === 0) {
				gameBoard.innerHTML = '<p style="grid-column: 1/-1; text-align: center; color: #888;">No game data</p>';
				return;
			}

			// Create cells for each position in the board
			for (let row = 0; row < board.length; row++) {
				for (let col = 0; col < board[row].length; col++) {
					const cell = document.createElement('div');
					cell.className = 'cell';

					const value = board[row][col];
					if (value !== 0) {
						cell.classList.add('filled');
						cell.classList.add(`block-${value}`);
					}

					gameBoard.appendChild(cell);
				}
			}
		}

		function updatePlayersList(playersInfo) {
			const playersList = document.getElementById('playersList');
			playersList.innerHTML = '';

			playersInfo.forEach((player, index) => {
				const playerDiv = document.createElement('div');
				playerDiv.style.cssText = 'background: #1e1e1e; padding: 10px; margin-bottom: 10px; border-left: 3px solid #4db8ff; border-radius: 4px;';

				playerDiv.innerHTML = `
					<div style="color: #4db8ff; font-weight: bold; margin-bottom: 5px;">Player ${index + 1}: ${player.name}</div>
					<div style="color: #44ff44; font-size: 14px;">Score: ${player.score}</div>
				`;

				playersList.appendChild(playerDiv);
			});

			document.getElementById('playerCount').textContent = playersInfo.length;
		}

		function startGame() {
			if (!socket || !socket.connected) {
				addLog('Not connected to server', 'error');
				return;
			}

			addLog('Starting game...', 'sent');
			socket.emit('startGame');
			document.getElementById('gameStatus').textContent = 'üéÆ RUNNING';
			document.getElementById('gameStatus').style.color = '#44ff44';

			socket.on('gameStarted', () => {
				addLog('‚úì Game started - gravity enabled (800ms interval)', 'received');
				addLog('üì° Listening for auto gameUpdate events...', 'info');
			});
		}

		function stopGame() {
			if (!socket || !socket.connected) {
				addLog('Not connected to server', 'error');
				return;
			}

			addLog('Stopping game...', 'sent');
			socket.emit('stopGame');
			document.getElementById('gameStatus').textContent = '‚è∏Ô∏è STOPPED';
			document.getElementById('gameStatus').style.color = '#ffaa00';
		}

		// Handle arrow keys for block movement
		document.addEventListener('keydown', (event) => {
			if (!socket || !socket.connected) return;

			switch (event.key) {
				case 'ArrowLeft':
					event.preventDefault();
					socket.emit('moveBlock', -1);
					addLog('‚¨ÖÔ∏è Move Left', 'sent');
					break;
				case 'ArrowRight':
					event.preventDefault();
					socket.emit('moveBlock', 1);
					addLog('‚û°Ô∏è Move Right', 'sent');
					break;
				case 'z':
				case 'Z':
					event.preventDefault();
					socket.emit('RotateBlock', 'clockwise');
					addLog('üîÑ Rotate Clockwise', 'sent');
					break;
				case 'x':
				case 'X':
					event.preventDefault();
					socket.emit('RotateBlock', 'counterclockwise');
					addLog('üîÑ Rotate Counter-Clockwise', 'sent');
					break;
				case 'r':
				case 'R':
					event.preventDefault();
					socket.emit('dropBlock');
					addLog('dropBlock', 'sent');
					break;
			}
		});

		// Auto-log initialization
		window.addEventListener('load', () => {
			addLog('üöÄ Socket Test Console Ready', 'info');
			addLog('Click "Connect" to connect to the server', 'info');
			addLog('üìå Use Arrow Left/Right to move the block', 'info');
			addLog('üìå Use Z to rotate clockwise, X to rotate counter-clockwise', 'info');

			// Initialize empty game board
			const emptyBoard = Array.from({length: 20}, () => Array(10).fill(0));
			displayGameBoard(emptyBoard);
		});
	</script>
</body>

</html>
